#!/bin/sh

echo "# This makefile was automatically generated by zeda-makefile-gen in ZEDA."
echo "# `date` by `whoami`"

output_make_plain(){
    cat << EOF
CC=gcc
CFLAGS=-Wall -O3

%: %.c
	\$(CC) \$(CFLAGS) \$< \$@
clean:
	rm -f *~
EOF
}

output_make_src(){
    cat << EOF
include ../config

ROOTDIR=..
LIBDIR=\$(ROOTDIR)/lib
INCLUDE=-I\$(ROOTDIR)/include

CHKDEP=`which zeda-chkdep`
ifneq (\$(CHKDEP),)
	ifneq (\$(DEPENDENCY),)
		INCLUDE+=\$(shell \$(CHKDEP) \$(DEPENDENCY) -l | tr -s " " "\n" | xargs -I{} echo \\\`{}-config -I\\\` | xargs)
	endif
endif

CC=gcc
STD=c89
CFLAGS=-Wall -fPIC -fno-common -O3 \$(INCLUDE) -funroll-loops -D __BUILD_DLL__=1
ifneq (\$(STD),)
      CFLAGS+="-std=\$(STD)"
endif

ifneq (\$(DEBUG),)
      CFLAGS+=-g
endif

LD=\$(CC)
LDFLAGS=-shared

include config.lib

ifeq (\$(CC),g++)
      DLIB=lib\$(PROJNAME)_cpp.so
      CCCMD=" CXX	"
else
      DLIB=lib\$(PROJNAME).so
      CCCMD=" CC	"
endif

ifneq (\$(shell \$(CC) --version | grep darwin),)
	LDFLAGS+="-install_name \$(PREFIX)/lib/\$(DLIB)"
endif

all: \$(DLIB)

\$(DLIB): \$(OBJ)
	@echo " LD	" \$^ "-o" \$@
	@\$(LD) \$(LDFLAGS) -o \$@ \$^ > /dev/null
	-@mv \$@ \$(LIBDIR)
%.o: %.c
ifneq (\$(DEBUG),)
	@echo \$(CCCMD) \$< "	(debug mode enabled)"
else
	@echo \$(CCCMD) \$<
endif
	@\$(CC) \$(CFLAGS) -c \$< > /dev/null
clean:
	@echo " CLEAN"
	-@rm -f *.o *~ \#* \$(DLIB)
EOF
}

output_make_tools(){
    cat << EOF
include ../config

BINDIR=\$(PREFIX)/bin

INSTALL=install -m 755
UNINSTALL=rm -f

CONFIGTOOL=\$(PROJNAME)-config
CONFIGGEN=\`which zeda-config-gen\`

INCLUDE=
LIB=
DEF=
LINK=-l\$(PROJNAME)
LINKCPP=-l\$(PROJNAME)_cpp

include config.tools

all: \$(CONFIGTOOL)

\$(CONFIGTOOL):
	@echo " GENERATE	" \$@
	-@rm -f \$@
	@\$(CONFIGGEN) -I "\$(INCLUDE)" -L "\$(LIB)" -D "\$(DEF)" -l "\$(LINK)" -lcpp "\$(LINKCPP)" -v \$(VERSION) > \$@
install: \$(CONFIGTOOL)
	@echo " INSTALL	" \$^
	@\$(INSTALL) \$^ \$(BINDIR)
clean:
	@echo " CLEAN"
	-@rm -f *.o *~ core \$(CONFIGTOOL)
uninstall:
	@echo " UNINSTALL	" \$(CONFIGTOOL)
	@cd \$(BINDIR); \$(UNINSTALL) \$(CONFIGTOOL)
EOF
}

output_make_app(){
    cat << EOF
include ../config

BINDIR=\$(PREFIX)/bin

INSTALL=install -m 755
UNINSTALL=rm -f

CONFIGTOOL=\$(PROJNAME)-config
LINK=\`\$(CONFIGTOOL) -l\`
LINKCPP=\`\$(CONFIGTOOL) -lcpp\`

CC=gcc
CXX=g++
CFLAGS=$2 -Wall -O3 \`\$(CONFIGTOOL) --cflags\`
TARGET=\$(shell ls *.c 2> /dev/null | xargs -I{} basename {} .c | xargs)

all: \$(TARGET)

%: %.c
	@echo " CC	" $<
	@\$(CC) \$(CFLAGS) -o \$@ \$< \$(LINK)
%: %.cpp
	@echo " CXX	" $<
	@\$(CXX) \$(CFLAGS) -o \$@ \$< \$(LINKCPP)
clean:
	@echo " CLEAN"
	-@rm -f *.o *~ core \$(TARGET)
install: \$(TARGET)
ifneq (\$(TARGET),)
	@echo " INSTALL	" \$^
	@\$(INSTALL) $^ \$(BINDIR)
endif
uninstall:
ifneq (\$(TARGET),)
	@echo " UNINSTALL	" \$(TARGET)
	@cd \$(BINDIR); \$(UNINSTALL) \$(TARGET)
endif
EOF
}

output_make_default(){
    cat << EOF
CONFIG:=\$(shell test -e config || cp config.org config; echo config)
include \$(CONFIG)

ROOTDIR:=.
INCDIR:=\$(ROOTDIR)/include/\$(PROJNAME)
SRCDIR:=\$(ROOTDIR)/src
LIBDIR:=\$(ROOTDIR)/lib
TOOLDIR:=\$(ROOTDIR)/tools
APPDIR:=\$(ROOTDIR)/app
DOCDIR:=\$(ROOTDIR)/doc
TESTDIR:=\$(ROOTDIR)/test
SAMPLEDIR:=\$(ROOTDIR)/example

CHKDEP=`which zeda-chkdep`

all: library devtools
library:
ifneq (\$(CHKDEP),)
ifneq (\$(DEPENDENCY),)
	@\$(CHKDEP) \$(DEPENDENCY) || exit 1
endif
endif
	@cd \$(SRCDIR); make
devtools:
	@cd \$(TOOLDIR); make
autotest:
	@cd \$(TESTDIR); ./test.sh
doc:
	@cd \$(DOCDIR); make
clean:
	-@rm -f \$(ROOTDIR)/*~ \$(INCDIR)/*~
	@cd \$(SRCDIR); make clean
	-@rm -f \$(LIBDIR)/*.so
	@cd \$(TOOLDIR); make clean
	@cd \$(APPDIR); make clean
	@cd \$(DOCDIR); make clean
	@cd \$(SAMPLEDIR); ./allclean.sh
install:
	@echo " INSTALL	library"
	-@install -m 755 \$(LIBDIR)/*.so \$(PREFIX)/lib/
	@echo " INSTALL	header files"
	-@install -m 755 -d \$(PREFIX)/include/\$(PROJNAME)
	-@install -m 644 \$(INCDIR)/*.h \$(PREFIX)/include/\$(PROJNAME)/
	@echo " INSTALL	tools"; cd \$(TOOLDIR); make install
	@echo " INSTALL	applications"; cd \$(APPDIR); make && make install
uninstall:
	@echo " UNINSTALL	library"
	-@rm -f \$(PREFIX)/lib/lib\$(PROJNAME).so \$(PREFIX)/lib/lib\$(PROJNAME)_cpp.so
	@echo " UNINSTALL	header files"
	-@rm -r \$(PREFIX)/include/\$(PROJNAME)
	@echo " UNINSTALL	tools"; cd \$(TOOLDIR); make uninstall
	@echo " UNINSTALL	applications"; cd \$(APPDIR); make uninstall
EOF
}

case $1 in
plain)
    output_make_plain
    ;;
lib)
    output_make_src
    ;;
tools)
    output_make_tools
    ;;
app)
    output_make_app
    ;;
*)
    output_make_default
    ;;
esac

exit 0
